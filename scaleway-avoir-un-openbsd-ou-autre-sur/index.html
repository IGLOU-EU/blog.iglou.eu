<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes,viewport-fit=cover"><title>[Scaleway] Avoir un OpenBSD (ou autre) sur les serveurs Scaleway | Blog Iglou.eu</title>
<meta property="og:title" content="[Scaleway] Avoir un OpenBSD (ou autre) sur les serveurs Scaleway | Blog Iglou.eu"><meta property="og:locale" content="fr_fr"><meta name=theme-color content="#dbf3f4"><meta name=author content="Adrien K"><meta name=description content="Cet article est issu d&amp;rsquo;une importation historique.
Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible. Scale my BSD üê° Moi: Vous savez quoi‚ÄØ?
Vous: Non, mais tu vas nous le dire !
Moi: En serveur, je pr√©f√®re grandement un OpenBSD √† un GNU/Linux
Vous: Et pourquoi donc ?
Moi: Pour pleins de raisons, comme son PF, HTTPD, SMTPD &amp;hellip;"><meta property="og:type" content="article"><meta property="og:description" content="Cet article est issu d&amp;rsquo;une importation historique.
Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible. Scale my BSD üê° Moi: Vous savez quoi‚ÄØ?
Vous: Non, mais tu vas nous le dire !
Moi: En serveur, je pr√©f√®re grandement un OpenBSD √† un GNU/Linux
Vous: Et pourquoi donc ?
Moi: Pour pleins de raisons, comme son PF, HTTPD, SMTPD &amp;hellip;"><meta property="og:publish_date" name=publish_date content="2018-05-11T16:00:00Z"><meta property="article:published_time" content="2018-05-11T16:00:00Z"><meta property="article:modified_time" content="2022-04-04T00:31:17+02:00"><meta property="article:author" content="Adrien K"><meta property="article:tag" content="BSD Serveur"><meta property="og:site_name" content="Blog Iglou.eu"><meta property="og:type" content="blog"><link rel=icon href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAxMDAgMTAwIj48dGV4dCB5PSIuOWVtIiBmb250LXNpemU9IjkwIj7wn5K+PC90ZXh0Pjwvc3ZnPg=="><link rel=me href=https://mastodon.social/@norihiori><link rel=canonical href=https://blog.iglou.eu/scaleway-avoir-un-openbsd-ou-autre-sur/><meta property="og:url" content="https://blog.iglou.eu/scaleway-avoir-un-openbsd-ou-autre-sur/"><link rel=stylesheet href=/css/makeup.min.css></head><body><header><h1 class="site_title monospace"><a href=/ class="link inherit">Blog.Iglou.eu</a></h1><div class="ariane monospace">/&#8239;<a href=/ class="link inherit">Home</a>&#8239;/&#8239;<h2 class="intext capitalize">[Scaleway] Avoir un OpenBSD (ou autre) sur les serveurs Scaleway</h2></div><aside class="infos monospace"><span class=infos_by>Par Adrien K
</span><span class="infos_date right">Le <time class="article_link__date_format text_neon blue" datetime=2018-05-11T16:00:00Z>11 May 2018</time>
¬∑ Maj le <time class="article_link__date_format text_neon blue" datetime=2022-04-04T00:31:17+02:00>04 Apr 2022</time>
</span><span class=infos_time>Lecture 5 minutes
</span><span class="infos_tags capitalize right"><a class="article_link__tag link important BSD" href=/tags/BSD/>BSD</a>
<a class="article_link__tag link important Serveur" href=/tags/Serveur/>Serveur</a></span></aside></header><main class=main><article class=article><div class="box warning monospace"><span>Cet article est issu d&rsquo;une importation historique.<br>Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible.</span></div><h2 id=scale-my-bsd->Scale my BSD üê°</h2><p><strong>Moi</strong>: Vous savez quoi‚ÄØ?<br><strong>Vous</strong>: Non, mais tu vas nous le dire !<br><strong>Moi</strong>: En serveur, je pr√©f√®re grandement un OpenBSD √† un GNU/Linux<br><strong>Vous</strong>: Et pourquoi donc ?<br><strong>Moi</strong>: Pour pleins de raisons, comme son PF, HTTPD, SMTPD &mldr;<br><strong>Vous</strong>: Mou√©, enfin SMTPD il est aussi sur d&rsquo;autres os, puis OpenBSD n&rsquo;est pas disponible de base, et les solutions trouv√©es jusque-l√† sur le net ne sont pas pratiques, et c&rsquo;est compliqu√© et blabla bla &mldr;</p><p><em>Je fais trop bien les questions et les r√©ponses avec moi-m√™me, quelle discussion constructive incroyable</em></p><p></p><figure class=article_content__img tabindex=0><img src=/images/3.bp.blogspot.com-mWlUOJQMjac-WvLYB_43YpI-AAAAAAAAAw0-b8Cjn1JSRAo6BlJHLVQGN3VqMUK2HesCACLcBGAs-s1600-28d14c0338da82ae394188f1cdb95505.gif alt="Image de presentation" referrerpolicy=no-referrer loading=lazy class=article_content__img_src><figcaption class=article_content__img_desc>Je ne suis pas aussi confiant que Barney pour le coup‚Ä¶</figcaption></figure><p></p><p><em>[Musique de Rocky]</em></p><h3 id=but>But</h3><ul><li>*Installer un OpenBSD sur les serveurs x86 de chez scaleway</li><li>**Pouvoir contr√¥ler l&rsquo;Os depuis l&rsquo;interface scaleway</li><li>*Ne pas devoir passer par une manipe manuelle √† chaque boot</li><li>*Pouvoir en faire une image pr√©s config √† d√©ployer</li><li>**Que √ßa tourne sur les x86 des gammes Start/BareMetal/Pro</li></ul><p><em>* C&rsquo;est la win</em><br><em>** C&rsquo;est la loose pour le moment</em></p><h3 id=observations>Observations</h3><ul><li>Avec &ldquo;fdisk -l&rdquo; on constate une partission EFI</li><li>Sans OS sur le disque, le serveur &ldquo;hard reboot&rdquo; puis passe en mode off</li><li>En √©coutant le port 80 au boot on peut surprendre une discutions avec 169.254.42.42</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>xxx IP xxx &gt; 169.254.42.42.http: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1225680221:1225680383, ack 1681506505, win 229, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>6113219</span> ecr 329066878<span style=color:#f92672>]</span>, length 162: HTTP
</span></span><span style=display:flex><span>E...<span style=color:#e6db74>&#34;.@.@...
</span></span></span><span style=display:flex><span><span style=color:#e6db74>.B...**.z.PI.e]d9......!......
</span></span></span><span style=display:flex><span><span style=color:#e6db74>.]G...)~PATCH /state HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Host: 169.254.42.42
</span></span></span><span style=display:flex><span><span style=color:#e6db74>User-Agent: curl/7.52.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Accept: */*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Content-Length: 26
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;</span>state_detail<span style=color:#e6db74>&#34;: &#34;</span>booted<span style=color:#e6db74>&#34;}
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>17:13:11.459660 IP 169.254.42.42.http &gt; xxx: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:164, ack 162, win 235, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>329067003</span> ecr 6113219<span style=color:#f92672>]</span>, length 163: HTTP: HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>E.....@.;.4...**
</span></span><span style=display:flex><span>.B..P.zd9..I.e............
</span></span><span style=display:flex><span>..<span style=color:#f92672>)</span>..<span style=color:#f92672>]</span>G.HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: Tengine
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#ae81ff>08</span> May <span style=color:#ae81ff>2018</span> 17:13:11 GMT
</span></span><span style=display:flex><span>Content-Type: text/plain
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>STATE_DETAIL<span style=color:#f92672>=</span>booted
</span></span></code></pre></div><ul><li>Avec un petit <code>grep -rn</code> on trouve un script contenant <code>STATE_DETAIL</code> nomm√© scw-signal-state</li></ul><h3 id=solution>Solution</h3><ol><li>Cr√©er un serveur x86 64 avec un volume 50G pour OpenBSD</li><li>Installer qemu et Dl miniroot**.fs</li><li>New VM miniroot**.fs et en utilisant le volume pr√©vu <code>qemu-system-x86_64 -curses -drive file=miniroot**.fs -drive file=/dev/vdb -net nic -net user</code></li><li>Installer OpenBSD comme vous voulez, sauf pour :<ul><li>IPv4 address for em0? (or &lsquo;dhcp&rsquo; or &rsquo;none&rsquo;) [dhcp]</li><li>Change the default console to com0? [no] yes_(Pour utiliser la console en ligne)_</li><li>Which disk is the root disk? (&rsquo;?&rsquo; for details) [wd0] wd1</li><li>Use (W)hole disk MBR, whole disk (G)PT or (E)dit? [whole] G <em>(Partition GTP pour EFI)</em></li><li>Installez BSD.mp affin d&rsquo;√©tre en kernel MultiProcessor <em>(il fonctionne aussi en sigle core)</em></li><li>√Ä la fin de l&rsquo;install, copi√© le hostname pour l&rsquo;interface vio0 <em>(nom de l&rsquo;interface des vps sous OpenBSD)</em> <code># cp /etc/hostname.em0 /etc/hostname.vio0</code></li></ul></li><li>Quand c&rsquo;est fini on √©teint tout, on fait un snapshot du volume et cr√©ation d&rsquo;un nouveau serveur avec ce snapshot</li><li>/*ATTENTION le serveur hard reboot apr√®s quelques minutes, temps que l&rsquo;on n&rsquo;envoie pas la validation, pour finir en erreur */</li><li>Une fois le serveur boot, il faut installer curl (et wget d&rsquo;apr√®s moi), puis mettre en place le script scw-signal-state (j&rsquo;ai h√©berg√© les scripts, car je ne les ai pas trouv√©s en ligne)<ul><li><code># pkg_add curl wget</code></li><li><code># wget https://git.iglou.eu/NonIgImport/Scaleway-scripts/raw/master/scw-signal-state</code></li><li><code># chmod +x scw-signal-state</code></li><li><code># scw-signal-state booted</code></li><li>puis vous l&rsquo;ajouter a cron ou rc.local ex: <a href=https://git.iglou.eu/NonIgImport/Scaleway-scripts/raw/master/rc.local class="article_content__link link inherit" rel="noreferrer nofollow noopener">https://git.iglou.eu/NonIgImport/Scaleway-scripts/raw/master/rc.local</a></li></ul></li><li>Vous pouvez √©teindre le serveur et OpenBSD afin de faire un snapshot stable.</li></ol><ul><li><em>Si le signal n&rsquo;est pas envoy√©, peut-√™tre que votre PATH est mal renseign√©, un petit &ldquo;whereis curl&rdquo; pour v√©rifier √ßa.</em></li><li><em>S&rsquo;il est impossible de r√©soudre les noms de domaines, modifiez votre /etc/resolv.conf en ajoutant par ex le name serveur de google 8.8.8.8. Le temps de fixer √ßa plus tard</em></li></ul><p>√Ä ce moment-l√†, vous pouvez r√©aliser une image d&rsquo;installation dans votre interface avec le snapshot pr√©c√©demment cr√©e.</p><p>Vous trouverez ici : <a href=https://git.iglou.eu/NonIgImport/Scaleway-scripts/tree/master class="article_content__link link inherit" rel="noreferrer nofollow noopener">https://git.iglou.eu/NonIgImport/Scaleway-scripts/tree/master</a> le repos ou j&rsquo;ai upload deux scripts scw-*, celui qui envoie le &ldquo;booted&rdquo; et un autre qui vous renvois toutes les informations relatives au serveur. J&rsquo;ai aussi mis une version modifi√©e de scw-signal-state, qui fait un loop temps qu&rsquo;elle n&rsquo;a pas pu effectuer l&rsquo;envoi du signal, car j&rsquo;avais de temps en temps un signal envoy√© avant que le serveur soit connect√©.</p><p></p><figure class=article_content__img tabindex=0><img src=/images/challenge-failed_o_424177.jpg alt="Image de presentation" referrerpolicy=no-referrer loading=lazy class=article_content__img_src></figure><p>Et √ßa ne fonctionne que sur la gamme start, donc un petit fail quand m√™me !</p><p><strong>Pour les serveurs BareMetal et Pro, n&rsquo;ayant pas la possibilit√© d‚Äôacc√©der au local boot, grub ou iPXE &mldr; Ce n&rsquo;est pas gagn√©. Mais je reste en recherche !</strong></p><p><strong>Rien ne devrait emp√™cher cette &ldquo;technique&rdquo; de fonctionner avec n&rsquo;importe quel Os.</strong></p><p>Si vous avez des questions ou des am√©liorations √† me proposer, je reste disponible :)</p><p><strong>√©a, les amis.</strong></p><aside class="article_comm right"><a class="article_comm__email btn inherit right monospace" href="mailto:adrien@iglou.eu?subject=%5BCommentaire%5D+%5bScaleway%5d%20Avoir%20un%20OpenBSD%20%28ou%20autre%29%20sur%20les%20serveurs%20Scaleway&body=Bonjour%20Adrien%2C%0D%0A">M'envoyer un commentaire</a>
¬∑
<a class="article_comm__issue btn inherit right monospace" href="https://github.com/IGLOU-EU/blog.iglou.eu/issues/new?title=Erreur:+%5bScaleway%5d%20Avoir%20un%20OpenBSD%20%28ou%20autre%29%20sur%20les%20serveurs%20Scaleway&body=Lien:+https%3a%2f%2fblog.iglou.eu%2fscaleway-avoir-un-openbsd-ou-autre-sur%2f%0A%0AMince+quel+est+mon+erreur+?%0A">Reporter une erreur</a></aside></article></main><footer><hr class=hr><p class="footer monospace center">Site et contenue sous CC0 - Iconographie par Font Awesome - Sans Cookies ni tracking</p></footer></body></html>