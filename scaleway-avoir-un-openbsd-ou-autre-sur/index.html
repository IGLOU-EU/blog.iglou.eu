<!doctype html><html lang=fr-fr dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes,viewport-fit=cover"><title>[Scaleway] Avoir un OpenBSD (ou autre) sur les serveurs Scaleway | Blog Iglou.eu</title>
<link rel=icon href=%7b%7d><link rel=canonical href=https://blog.iglou.eu/scaleway-avoir-un-openbsd-ou-autre-sur/><meta itemprop=name content="[Scaleway] Avoir un OpenBSD (ou autre) sur les serveurs Scaleway"><meta itemprop=description content="Cet article est issu d‚Äôune importation historique.
Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible. Scale my BSD üê° Moi: Vous savez quoi‚ÄØ?
Vous: Non, mais tu vas nous le dire !
Moi: En serveur, je pr√©f√®re grandement un OpenBSD √† un GNU/Linux
Vous: Et pourquoi donc ?
Moi: Pour pleins de raisons, comme son PF, HTTPD, SMTPD ‚Ä¶
Vous: Mou√©, enfin SMTPD il est aussi sur d‚Äôautres os, puis OpenBSD n‚Äôest pas disponible de base, et les solutions trouv√©es jusque-l√† sur le net ne sont pas pratiques, et c‚Äôest compliqu√© et blabla bla ‚Ä¶"><meta itemprop=datePublished content="2018-05-11T16:00:00+00:00"><meta itemprop=dateModified content="2018-05-14T11:37:53+00:00"><meta itemprop=wordCount content="771"><meta itemprop=keywords content="Bsd,Serveur"><meta property="og:url" content="https://blog.iglou.eu/scaleway-avoir-un-openbsd-ou-autre-sur/"><meta property="og:site_name" content="Blog Iglou.eu"><meta property="og:title" content="[Scaleway] Avoir un OpenBSD (ou autre) sur les serveurs Scaleway"><meta property="og:description" content="Cet article est issu d‚Äôune importation historique.
Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible. Scale my BSD üê° Moi: Vous savez quoi‚ÄØ?
Vous: Non, mais tu vas nous le dire !
Moi: En serveur, je pr√©f√®re grandement un OpenBSD √† un GNU/Linux
Vous: Et pourquoi donc ?
Moi: Pour pleins de raisons, comme son PF, HTTPD, SMTPD ‚Ä¶
Vous: Mou√©, enfin SMTPD il est aussi sur d‚Äôautres os, puis OpenBSD n‚Äôest pas disponible de base, et les solutions trouv√©es jusque-l√† sur le net ne sont pas pratiques, et c‚Äôest compliqu√© et blabla bla ‚Ä¶"><meta property="og:locale" content="fr_fr"><meta property="og:type" content="article"><meta property="article:published_time" content="2018-05-11T16:00:00+00:00"><meta property="article:modified_time" content="2018-05-14T11:37:53+00:00"><meta property="article:tag" content="Bsd"><meta property="article:tag" content="Serveur"><link href=https://blog.iglou.eu/index.xml rel=alternate type=application/rss+xml title="Blog Iglou.eu"><link rel=stylesheet href=/css/style.min.04f4b7997c4f8621b627767bda0b5f35702bcb14fff156b6c784df451dba02e0.css integrity="sha256-BPS3mXxPhiG2J3Z72gtfNXAryxT/8Va2x4TfRR26AuA=" crossorigin=anonymous></head><body><div class=toggle-widget id=open-left_panel><style>#open-left_panel .toggle-close{display:none}#open-left_panel:target~.content-main .left_panel{display:block;position:fixed;top:0;left:0;right:0;bottom:0;overflow:auto;z-index:10}#open-left_panel:target .toggle-icon-line{background-color:var(--color-wtoggle-line-focus)}#open-left_panel:target .toggle-icon-line.vertical{transform:rotate(360deg)}#open-left_panel:target .toggle-icon-line.horizontal{transform:rotate(180deg)}#open-left_panel:target .toggle-close{display:initial}#open-left_panel:target .toggle-open{display:none}</style><div class=toggle-icon><span class="toggle-icon-line vertical"></span>
<span class="toggle-icon-line horizontal"></span></div><a class="toggle-open toggle-link" title="Ouvrir Left panel" href=#open-left_panel></a><a class="toggle-close toggle-link" title="Fermer Left panel" href=#close-left_panel></a></div><header class=site-header><h1>Blog Iglou.eu</h1><nav class=main-menu><ul><li><a href=/>Accueil</a></li></ul></nav></header><main class=content-main><div class=top_panel><aside class=article-info><span class=date-info>Le <time class=published datetime=2018-05-11T16:00:00Z>11 May 2018
</time>¬∑ Maj le <time class=editited datetime=2018-05-14T11:37:53Z>14 May 2018
</time></span><span class=spacer></span>
<span class=reading-time>3-5 minutes</span></aside></div><div class=left_panel><aside class=sidebar><div class=toc><h2 class=toc-title>Table des Mati√®res</h2><nav id=TableOfContents><ul><li><a href=#scale-my-bsd->Scale my BSD üê°</a><ul><li><a href=#but>But</a></li><li><a href=#observations>Observations</a></li><li><a href=#solution>Solution</a></li></ul></li></ul></nav></div><div class=tags><h2 class=tags-title>Tags</h2><ul class=tags-list><li class=tags-item><a class=tags-link href=https://blog.iglou.eu/tags/bsd/>Bsd</a></li><li class=tags-item><a class=tags-link href=https://blog.iglou.eu/tags/serveur/>Serveur</a></li></ul></div></aside></div><div class=right_panel><article class="blog-article markdown"><div class="box warning monospace"><span>Cet article est issu d&rsquo;une importation historique.<br>Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible.</span></div><h2 id=scale-my-bsd->Scale my BSD üê°</h2><p><strong>Moi</strong>: Vous savez quoi‚ÄØ?<br><strong>Vous</strong>: Non, mais tu vas nous le dire !<br><strong>Moi</strong>: En serveur, je pr√©f√®re grandement un OpenBSD √† un GNU/Linux<br><strong>Vous</strong>: Et pourquoi donc ?<br><strong>Moi</strong>: Pour pleins de raisons, comme son PF, HTTPD, SMTPD &mldr;<br><strong>Vous</strong>: Mou√©, enfin SMTPD il est aussi sur d&rsquo;autres os, puis OpenBSD n&rsquo;est pas disponible de base, et les solutions trouv√©es jusque-l√† sur le net ne sont pas pratiques, et c&rsquo;est compliqu√© et blabla bla &mldr;</p><p><em>Je fais trop bien les questions et les r√©ponses avec moi-m√™me, quelle discussion constructive incroyable</em></p><p></p><figure class=article-img><a href=/images/3.bp.blogspot.com-mWlUOJQMjac-WvLYB_43YpI-AAAAAAAAAw0-b8Cjn1JSRAo6BlJHLVQGN3VqMUK2HesCACLcBGAs-s1600-28d14c0338da82ae394188f1cdb95505.gif target=_blank title="Ouvrir l'image dans un onglet"><img src=/images/3.bp.blogspot.com-mWlUOJQMjac-WvLYB_43YpI-AAAAAAAAAw0-b8Cjn1JSRAo6BlJHLVQGN3VqMUK2HesCACLcBGAs-s1600-28d14c0338da82ae394188f1cdb95505.gif alt="Image de presentation" referrerpolicy=no-referrer loading=lazy class=img-src></a><figcaption class=img-desc>Je ne suis pas aussi confiant que Barney pour le coup‚Ä¶</figcaption></figure><p></p><p><em>[Musique de Rocky]</em></p><h3 id=but>But</h3><ul><li>*Installer un OpenBSD sur les serveurs x86 de chez scaleway</li><li>**Pouvoir contr√¥ler l&rsquo;Os depuis l&rsquo;interface scaleway</li><li>*Ne pas devoir passer par une manipe manuelle √† chaque boot</li><li>*Pouvoir en faire une image pr√©s config √† d√©ployer</li><li>**Que √ßa tourne sur les x86 des gammes Start/BareMetal/Pro</li></ul><p><em>* C&rsquo;est la win</em><br><em>** C&rsquo;est la loose pour le moment</em></p><h3 id=observations>Observations</h3><ul><li>Avec &ldquo;fdisk -l&rdquo; on constate une partission EFI</li><li>Sans OS sur le disque, le serveur &ldquo;hard reboot&rdquo; puis passe en mode off</li><li>En √©coutant le port 80 au boot on peut surprendre une discutions avec 169.254.42.42</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>xxx IP xxx &gt; 169.254.42.42.http: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1225680221:1225680383, ack 1681506505, win 229, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>6113219</span> ecr 329066878<span style=color:#f92672>]</span>, length 162: HTTP
</span></span><span style=display:flex><span>E...<span style=color:#e6db74>&#34;.@.@...
</span></span></span><span style=display:flex><span><span style=color:#e6db74>.B...**.z.PI.e]d9......!......
</span></span></span><span style=display:flex><span><span style=color:#e6db74>.]G...)~PATCH /state HTTP/1.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Host: 169.254.42.42
</span></span></span><span style=display:flex><span><span style=color:#e6db74>User-Agent: curl/7.52.1
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Accept: */*
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Content-Type: application/json
</span></span></span><span style=display:flex><span><span style=color:#e6db74>Content-Length: 26
</span></span></span><span style=display:flex><span><span style=color:#e6db74>
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;</span>state_detail<span style=color:#e6db74>&#34;: &#34;</span>booted<span style=color:#e6db74>&#34;}
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>17:13:11.459660 IP 169.254.42.42.http &gt; xxx: Flags <span style=color:#f92672>[</span>P.<span style=color:#f92672>]</span>, seq 1:164, ack 162, win 235, options <span style=color:#f92672>[</span>nop,nop,TS val <span style=color:#ae81ff>329067003</span> ecr 6113219<span style=color:#f92672>]</span>, length 163: HTTP: HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>E.....@.;.4...**
</span></span><span style=display:flex><span>.B..P.zd9..I.e............
</span></span><span style=display:flex><span>..<span style=color:#f92672>)</span>..<span style=color:#f92672>]</span>G.HTTP/1.1 <span style=color:#ae81ff>200</span> OK
</span></span><span style=display:flex><span>Server: Tengine
</span></span><span style=display:flex><span>Date: Tue, <span style=color:#ae81ff>08</span> May <span style=color:#ae81ff>2018</span> 17:13:11 GMT
</span></span><span style=display:flex><span>Content-Type: text/plain
</span></span><span style=display:flex><span>Content-Length: <span style=color:#ae81ff>20</span>
</span></span><span style=display:flex><span>Connection: keep-alive
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>STATE_DETAIL<span style=color:#f92672>=</span>booted
</span></span></code></pre></div><ul><li>Avec un petit <code>grep -rn</code> on trouve un script contenant <code>STATE_DETAIL</code> nomm√© scw-signal-state</li></ul><h3 id=solution>Solution</h3><ol><li>Cr√©er un serveur x86 64 avec un volume 50G pour OpenBSD</li><li>Installer qemu et Dl miniroot**.fs</li><li>New VM miniroot**.fs et en utilisant le volume pr√©vu <code>qemu-system-x86_64 -curses -drive file=miniroot**.fs -drive file=/dev/vdb -net nic -net user</code></li><li>Installer OpenBSD comme vous voulez, sauf pour :<ul><li>IPv4 address for em0? (or &lsquo;dhcp&rsquo; or &rsquo;none&rsquo;) [dhcp]</li><li>Change the default console to com0? [no] yes_(Pour utiliser la console en ligne)_</li><li>Which disk is the root disk? (&rsquo;?&rsquo; for details) [wd0] wd1</li><li>Use (W)hole disk MBR, whole disk (G)PT or (E)dit? [whole] G <em>(Partition GTP pour EFI)</em></li><li>Installez BSD.mp affin d&rsquo;√©tre en kernel MultiProcessor <em>(il fonctionne aussi en sigle core)</em></li><li>√Ä la fin de l&rsquo;install, copi√© le hostname pour l&rsquo;interface vio0 <em>(nom de l&rsquo;interface des vps sous OpenBSD)</em> <code># cp /etc/hostname.em0 /etc/hostname.vio0</code></li></ul></li><li>Quand c&rsquo;est fini on √©teint tout, on fait un snapshot du volume et cr√©ation d&rsquo;un nouveau serveur avec ce snapshot</li><li>/*ATTENTION le serveur hard reboot apr√®s quelques minutes, temps que l&rsquo;on n&rsquo;envoie pas la validation, pour finir en erreur */</li><li>Une fois le serveur boot, il faut installer curl (et wget d&rsquo;apr√®s moi), puis mettre en place le script scw-signal-state (j&rsquo;ai h√©berg√© les scripts, car je ne les ai pas trouv√©s en ligne)<ul><li><code># pkg_add curl wget</code></li><li><code># wget https://git.iglou.eu/NonIgImport/Scaleway-scripts/raw/master/scw-signal-state</code></li><li><code># chmod +x scw-signal-state</code></li><li><code># scw-signal-state booted</code></li><li>puis vous l&rsquo;ajouter a cron ou rc.local ex:
<a href=https://git.iglou.eu/NonIgImport/Scaleway-scripts/raw/master/rc.local class=external-link rel="noreferrer nofollow noopener" target=_blank>https://git.iglou.eu/NonIgImport/Scaleway-scripts/raw/master/rc.local</a></li></ul></li><li>Vous pouvez √©teindre le serveur et OpenBSD afin de faire un snapshot stable.</li></ol><ul><li><em>Si le signal n&rsquo;est pas envoy√©, peut-√™tre que votre PATH est mal renseign√©, un petit &ldquo;whereis curl&rdquo; pour v√©rifier √ßa.</em></li><li><em>S&rsquo;il est impossible de r√©soudre les noms de domaines, modifiez votre /etc/resolv.conf en ajoutant par ex le name serveur de google 8.8.8.8. Le temps de fixer √ßa plus tard</em></li></ul><p>√Ä ce moment-l√†, vous pouvez r√©aliser une image d&rsquo;installation dans votre interface avec le snapshot pr√©c√©demment cr√©e.</p><p>Vous trouverez ici :
<a href=https://git.iglou.eu/NonIgImport/Scaleway-scripts/tree/master class=external-link rel="noreferrer nofollow noopener" target=_blank>https://git.iglou.eu/NonIgImport/Scaleway-scripts/tree/master</a>
le repos ou j&rsquo;ai upload deux scripts scw-*, celui qui envoie le &ldquo;booted&rdquo; et un autre qui vous renvois toutes les informations relatives au serveur. J&rsquo;ai aussi mis une version modifi√©e de scw-signal-state, qui fait un loop temps qu&rsquo;elle n&rsquo;a pas pu effectuer l&rsquo;envoi du signal, car j&rsquo;avais de temps en temps un signal envoy√© avant que le serveur soit connect√©.</p><p></p><figure class=article-img><a href=/images/challenge-failed_o_424177.jpg target=_blank title="Ouvrir l'image dans un onglet"><img src=/images/challenge-failed_o_424177.jpg alt="Image de presentation" referrerpolicy=no-referrer loading=lazy class=img-src></a></figure><p>Et √ßa ne fonctionne que sur la gamme start, donc un petit fail quand m√™me !</p><p><strong>Pour les serveurs BareMetal et Pro, n&rsquo;ayant pas la possibilit√© d‚Äôacc√©der au local boot, grub ou iPXE &mldr; Ce n&rsquo;est pas gagn√©. Mais je reste en recherche !</strong></p><p><strong>Rien ne devrait emp√™cher cette &ldquo;technique&rdquo; de fonctionner avec n&rsquo;importe quel Os.</strong></p><p>Si vous avez des questions ou des am√©liorations √† me proposer, je reste disponible :)</p><p><strong>√©a, les amis.</strong></p></article></div></main><footer class=site-footer><p>Copyright 2024 CC0 - Sans Cookies ni tracking</p></footer></body></html>