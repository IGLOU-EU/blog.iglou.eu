<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes,viewport-fit=cover"><title>[OpenBSD] Juste de l'OpenHttpd, du LuaPatterns et du Let's encrypt | Blog Iglou.eu</title><meta property="og:title" content="[OpenBSD] Juste de l'OpenHttpd, du LuaPatterns et du Let's encrypt | Blog Iglou.eu"><meta property="og:locale" content="fr_fr"><meta name=theme-color content="#dbf3f4"><meta name=author content="Adrien K"><meta name=description content="Cet article est issu d'une importation historique.
Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible. Le dernier espoir : OpenHTTPD 
 
Salut à toi lecteur.
Moi, c&amp;rsquo;est Luc, Jean-Luc, Jean-Luc qui porte un sky, lecteur ! Si tu es là, c&amp;rsquo;est qu&amp;rsquo;tu connais un peu le bousin, la force est déjà avec toi et elle t&amp;rsquo;a mené à moi."><meta property="og:type" content="article"><meta property="og:description" content="Cet article est issu d'une importation historique.
Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible. Le dernier espoir : OpenHTTPD 
 
Salut à toi lecteur.
Moi, c&amp;rsquo;est Luc, Jean-Luc, Jean-Luc qui porte un sky, lecteur ! Si tu es là, c&amp;rsquo;est qu&amp;rsquo;tu connais un peu le bousin, la force est déjà avec toi et elle t&amp;rsquo;a mené à moi."><meta property="og:publish_date" name=publish_date content="2018-08-02T20:18:00Z"><meta property="article:published_time" content="2018-08-02T20:18:00Z"><meta property="article:modified_time" content="2022-04-04T00:31:17+02:00"><meta property="article:author" content="Adrien K"><meta property="article:tag" content="BSD Serveur memo"><meta property="og:site_name" content="Blog Iglou.eu"><meta property="og:type" content="blog"><link rel=icon href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E%F0%9F%92%BE%3C/text%3E%3C/svg%3E"><link rel=canonical href=https://blog.iglou.eu/openbsd-juste-de-lopenhttpd-du/><meta property="og:url" content="https://blog.iglou.eu/openbsd-juste-de-lopenhttpd-du/"><style>:root{--c-dark:#33331a;--c-light:#dbf3f4;--c-primary:var(--c-light);--c-secondary:var(--c-dark);--ff-monospace:'Roboto Mono', SFMono-Regular, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;--ff-sans-serif:'Roboto', "Segoe UI", "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif}pre,code{--c-secondary:var(--c-light);--c-primary:var(--c-dark)}.btn:hover,.btn:focus{--c-primary:var(--c-dark);--c-secondary:var(--c-light)}*,::after,::before{box-sizing:border-box}.link.inherit{color:inherit}.link.important{color:var(--c-primary);border:.1em dotted transparent;padding:.25em .5em;text-decoration:underline double .05em}.link.important:hover,.link.important:focus{border-color:var(--c-primary);text-decoration:underline .1em}.link.svg{line-height:0;text-decoration:none}.link.svg>svg{fill:var(--c-primary);height:2em}.btn{color:var(--c-primary);border:.1em solid;padding:.25em .5em;display:inline-block;text-decoration:none;background-color:var(--c-secondary)}.box{gap:1em;border:.1em solid;padding:.5em 1em;display:grid;grid-template-columns:auto 1fr}.box::before{content:"";font-size:2em;line-height:.3em}.box.warning::before{content:"⚠"}.intext{font-size:inherit;display:inline}.monospace{font-family:var(--ff-monospace)}.capitalize{text-transform:capitalize}.right{text-align:right}.center{text-align:center}.m0{margin:0}.emoji{color:transparent;text-shadow:0 0 0 var(--c-primary)}.hr{margin:1em 0;border:none;border-bottom:.1em solid var(--c-primary)}.infos,.ariane{padding:.25em .5em;font-weight:700}.infos{gap:.5em;display:grid;margin-top:.5em;margin-bottom:.5em;grid-template-columns:1fr auto}.ariane{border:.1em solid var(--c-primary);border-left:none;border-right:none}body{color:var(--c-primary);font-size:1.2rem;line-height:1.4rem;font-family:var(--ff-sans-serif);background-color:var(--c-secondary);max-width:70em;margin:auto}.article h2::after{content:"";display:block;width:60%;height:1px;background-color:var(--c-primary);margin-top:.15em}pre{color:var(--c-primary);padding:1em;overflow:auto;max-height:100vh;background:var(--c-secondary)}code:not([data-lang]){color:var(--c-primary);background:var(--c-secondary);font-family:var(--ff-monospace);border-radius:3px}.site_title{font-size:3em;text-align:center;line-height:initial;text-shadow:0 0 1px var(--c-primary),0 0 1px var(--c-primary)}.article{margin:1em auto;max-width:80rem}.article_content__img{width:30em;color:var(--c-secondary);cursor:pointer;padding:1em;max-width:100%;text-align:center;font-style:italic;font-weight:700;background-color:var(--c-primary)}.article_content__img_src,.article_content__img:focus{width:100%}.article_content__img_src{max-height:50vh;object-fit:contain}.article_content__img:focus .article_content__img_src{max-height:100vh}.article_comm{margin-top:2em}.main.branch{display:grid;line-height:1.5em;grid-template-columns:minmax(25em,2fr)minmax(10em,1fr)}.articles{width:fit-content;margin:auto}.article_link{border:.1em solid var(--c-primary);margin:1em 0;padding:1.5em;max-width:50em;font-weight:700}.article_link__header,.article_link__footer{gap:1em;display:grid}.article_link__header{margin-bottom:1.5em;grid-template-columns:minmax(15rem,1fr)1fr}.article_link__footer{margin-top:2em;grid-template-columns:1fr auto}.article_link__title>.link{line-height:1.25em;text-decoration:underline .1em transparent}.article_link__title>.link:hover,.article_link__title>.link:focus{text-decoration-color:var(--c-primary)}.paginator{font-size:1.25em;text-align:center}.author{color:var(--c-primary);width:fit-content;margin:1em auto;height:fit-content;padding:0 1em 1em;max-width:20em;background-color:var(--c-secondary)}.author_view{border-radius:1em;width:100%}.author_desc__name{margin-bottom:.25em}.author_social{display:flex;justify-content:space-between}@media(max-width:768px){body{font-size:1rem}.site_title{font-size:1.8em}.main.branch{display:block}.author{max-width:initial}.author_view{max-width:20em}.infos{display:block}.infos>span{padding:0 .15em;border-style:solid;border-width:0 0 0 1px}.article_content__img{margin:auto}.article{margin:1em .15em}.article_comm .btn{margin:.25em}}</style></head><body><header><h1 class="site_title monospace"><a href=/ class="link inherit">Blog.Iglou.eu</a></h1><div class="ariane monospace">/&#8239;<a href=/ class="link inherit">Home</a>&#8239;/&#8239;<h2 class="intext capitalize">[OpenBSD] Juste de l'OpenHttpd, du LuaPatterns et du Let's encrypt</h2></div><aside class="infos monospace"><span class=infos_by>Par Adrien K</span>
<span class="infos_date right">Le <time class="article_link__date_format text_neon blue" datetime=2018-08-02T20:18:00Z>02 Aug 2018</time>
· Maj le <time class="article_link__date_format text_neon blue" datetime=2022-04-04T00:31:17+02:00>04 Apr 2022</time></span>
<span class=infos_time>Lecture 5 minutes</span>
<span class="infos_tags capitalize right"><a class="article_link__tag link important BSD" href=/tags/BSD/>BSD</a>
<a class="article_link__tag link important Serveur" href=/tags/Serveur/>Serveur</a>
<a class="article_link__tag link important memo" href=/tags/memo/>memo</a></span></aside></header><main class=main><article class=article><div class="box warning monospace"><span>Cet article est issu d'une importation historique.<br>Il fut fait sans correcteur orthographique et grammaticale, il est aussi fort probable que des images et liens soient indisponible.</span></div><h2 id=le-dernier-espoir--openhttpd>Le dernier espoir : OpenHTTPD</h2><p></p><figure class=article_content__img tabindex=0><img src=/images/2.bp.blogspot.com-3v13E4KCfGI-W2IlD-UYSNI-AAAAAAAAAyw-tZu9O6AeJIIPSvYI00qW1i5LLzErnnBVACPcBGAYYCw-s1600-openhttpd-logo.png alt="Image de presentation" referrerpolicy=no-referrer loading=lazy class=article_content__img_src></figure><p></p><p>Salut à toi lecteur.</p><p>Moi, c&rsquo;est Luc, Jean-Luc, Jean-Luc qui porte un sky, lecteur !<br>Si tu es là, c&rsquo;est qu&rsquo;tu connais un peu le bousin, la force est déjà avec toi et elle t&rsquo;a mené à moi.</p><p>J&rsquo;n&rsquo;vais pas t&rsquo;parler comme à un débutant, et si tu ne comprends pas, tu dois juste écouter 3 personnes, Mme.man toujours là pour te guider, Mr.prompt qui fait souvent des sorties et Mme.log une véritable pipelette, cette dernière, n&rsquo;hésite pas à la &ldquo;tail&rdquo; afin de couper court à la discussion (en plus elle radote).</p><p>Comme tu le sais déjà, depuis OpenBSD 5.6, on n&rsquo;utilise plus les technos de l&rsquo;empire comme apache ou nginx, mais une production de l&rsquo;Alliance, OpenHTTPD.</p><p>Bon allé, fini avec le blabla, prends ton LightKeyboard et petit récap</p><h3 id=pour-activer-httpd-par-def>Pour activer httpd par def</h3><pre tabindex=0><code>rcctl enable httpd
</code></pre><h3 id=le-redémarrer>Le redémarrer</h3><pre tabindex=0><code>rcctl restart httpd
</code></pre><h3 id=pour-debug-le-fichier-de-conf>Pour debug le fichier de conf</h3><pre tabindex=0><code>httpd -n
</code></pre><p>Puis merde pour les patterns lua vas lire le manuel, tout ce que t&rsquo;as à savoir c&rsquo;est qu&rsquo;il n&rsquo;y a pas de négation ni de &ldquo;ou&rdquo; logique, les paternes lua à gérer en gros ça prends 500 lignes de code, la regex +4.000 lignes… alors bon !
<a href=https://www.lua.org/pil/20.2.html class="article_content__link link inherit" rel="noreferrer nofollow noopener">https://www.lua.org/pil/20.2.html</a></p><p>Et pour let&rsquo;s encrypt, moi j&rsquo;utilise dehydrated, ne me demande pas pourquoi c&rsquo;est comme ça !
<a href=https://github.com/lukas2511/dehydrated class="article_content__link link inherit" rel="noreferrer nofollow noopener">https://github.com/lukas2511/dehydrated</a></p><p></p><figure class=article_content__img tabindex=0><img src=/images/itsatrap.jpg alt="Image de presentation" referrerpolicy=no-referrer loading=lazy class=article_content__img_src><figcaption class=article_content__img_desc>Ne tombe pas dans les pièges !</figcaption></figure><p></p><p>Si on veut QUE du HTTPS, on peut simplement faire un &ldquo;default&rdquo; sur le port 80 qui redirige sur le 443 via un simple : <code>block return 301 "https://$HTTP_HOST$REQUEST_URI"</code>, la base, on connait tous.</p><p>Mais si on désire certifier via let&rsquo;s encrypt par exemple, ba ça n&rsquo;marche pas (ça a peut être changé dernièrement &mldr;), il faut une variante HTTP pour chaque domaine.
Bon c&rsquo;est chiant, car moi je n&rsquo;veux pas de variante HTTP et je convoite que tous les challenges se passent au même endroit.
L&rsquo;idée est d&rsquo;utiliser un défaut donc <code>location</code> serait &ldquo;si la demande n&rsquo;est pas.well-known&rdquo; alors on redirige.</p><p>Pour utiliser des patterns, on a <code>location match</code> (t&rsquo;as pas compris ? Retourne lire la doc httpd.conf), sauf qu&rsquo;il n&rsquo;utilise pas regex, mais lua patterns et comme je t&rsquo;ai l&rsquo;ai déjà dit (putain t&rsquo;écoute vraiment rien &mldr;), il ne gère pas la négation !</p><h3 id=en-gros-voici-la-magouille>En gros voici la magouille.</h3><p>Si la requête débute par de l&rsquo;alphanumérique ou contient uniquement <code>/</code> alors on redirige.</p><p>Il n&rsquo;y a pas de problème avec les ancres, <code>toto.com/#a</code> est redirigé, car il n&rsquo;est pas envoyé en GET, la requête est : <code>"GET / HTTP/1.1" 200</code></p><p>En revanche, les requêtes en <code>/?toto=tata</code>, ne devrait pas être redirigé sans ajouter une ligne avec un nouveau pattern &mldr; Pourtant, <code>"GET /?toto=tata HTTP/1.1" 301</code>, on est correctement redirigé… J&rsquo;ai dû louper un truc, n&rsquo;hésite pas à m&rsquo;expliquer.</p><pre tabindex=0><code class=language-conf data-lang=conf>server &#34;default&#34; {
        listen on * port 80

        root &#34;/htdocs&#34;
        directory no index

        location match &#34;^/%w&#34; {
                block return 301 &#34;https://$HTTP_HOST$REQUEST_URI&#34;
        }

        location match &#34;^/$&#34; {
                block return 301 &#34;https://$HTTP_HOST$REQUEST_URI&#34;
        }
}
</code></pre><p>Si jamais t&rsquo;a mieux gamin, dis le moi. Tous les challenges sont dans <code>/htdocs/.well-known/acme-challenge/*</code> accessible en port 80, le reste exclusivement en 443 ou redirigé comme il faut. On pourrait effectivement améliorer ça avec un root directement dans un doc acme, et ajouter une <code>location</code> &mldr; blablabla root / &mldr; blablabla. Mais j&rsquo;ai d&rsquo;autre truc à faire, comme la vidange de mon speeder</p><hr><h3 id=tien-ton-script>Tien ton script</h3><p>J&rsquo;ai aussi un petit script à partager avec toi, il me permet d&rsquo;ajouter un domaine rapidement en CLI <a href=https://git.iglou.eu/Production/addWebSite/blob/master/addWebSite.sh class="article_content__link link inherit" rel="noreferrer nofollow noopener">addWebSite.sh</a>.</p><p>Bon le script ne fait même pas 100 lignes, il est grossier, simple, les echo font office de commentaires, ça ne devrait pas être compliqué à comprendre pour ceux qui n&rsquo;touche jamais a un shell.</p><hr><h3 id=ba-quoi-php->Ba quoi PHP ?</h3><p>Au passage, PHP, pour ceux qui l&rsquo;utilisent&mldr; Il faut installer php et php-cgi.
Puis comme httpd est en chroot, il faut un sock php dans son run.
Pour ça on utilise le service <code>php fpm</code>, ex avec php7: <code>rcctl start php70_fpm</code>.</p><p>Les libs disponibles sont dans <code>/etc/php-7.0.sample/</code>, et sont à link avec un <code>ln -s</code> dans <code>/etc/php-7.0/</code>
La conf de PHP <code>fpm</code> Quelle que soit sa version est dans <code>/etc/php-fpm.conf</code>.</p><p>Ne reste plus qu&rsquo;à utiliser un truc du genre :</p><pre tabindex=0><code class=language-conf data-lang=conf>location &#34;*.php&#34; {
    fastcgi socket &#34;/run/php-fpm.sock&#34;
}
</code></pre><hr><p><em>Comme toujours, si je raconte des conneries, dites le moi, ça évitera au clampin qui passe dans le coin d&rsquo;appliquer celle-ci.</em></p><p><strong>éa, les amis.</strong></p><aside class="article_comm right"><a class="article_comm__email btn inherit right monospace" href="mailto:adrien@iglou.eu?subject=%5BCommentaire%5D+%5bOpenBSD%5d%20Juste%20de%20l%27OpenHttpd%2c%20du%20LuaPatterns%20et%20du%20Let%27s%20encrypt&body=Bonjour%20Adrien%2C%0D%0A">M'envoyer un commentaire</a>
·
<a class="article_comm__issue btn inherit right monospace" href="https://github.com/IGLOU-EU/blog.iglou.eu/issues/new?title=Erreur:+%5bOpenBSD%5d%20Juste%20de%20l%27OpenHttpd%2c%20du%20LuaPatterns%20et%20du%20Let%27s%20encrypt&body=Lien:+https%3a%2f%2fblog.iglou.eu%2fopenbsd-juste-de-lopenhttpd-du%2f%0A%0AMince+quel+est+mon+erreur+?%0A">Reporter une erreur</a></aside></article></main><footer><hr class=hr><p class="footer monospace center">Site et contenue sous CC0 - Iconographie par Font Awesome - Sans Cookies ni tracking</p></footer></body></html>