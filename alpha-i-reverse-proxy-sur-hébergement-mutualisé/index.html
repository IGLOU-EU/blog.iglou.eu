<!doctype html><html lang=fr-fr dir=ltr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes,viewport-fit=cover"><title>[Alpha I] Reverse Proxy Sur Hébergement Mutualisé | Blog Iglou.eu</title>
<link rel=icon href=%7b%7d><link rel=canonical href=https://blog.iglou.eu/alpha-i-reverse-proxy-sur-h%C3%A9bergement-mutualis%C3%A9/><meta itemprop=name content="[Alpha I] Reverse Proxy Sur Hébergement Mutualisé"><meta itemprop=description content="Du reverse proxy pour code arbitraire sur hébergement mutualisé"><meta itemprop=datePublished content="2022-04-07T00:42:19+02:00"><meta itemprop=dateModified content="2023-11-04T13:52:46+01:00"><meta itemprop=wordCount content="1222"><meta itemprop=keywords content="Alpha,Hébergement Mutualisé,Niveau:intermédiaire"><meta property="og:url" content="https://blog.iglou.eu/alpha-i-reverse-proxy-sur-h%C3%A9bergement-mutualis%C3%A9/"><meta property="og:site_name" content="Blog Iglou.eu"><meta property="og:title" content="[Alpha I] Reverse Proxy Sur Hébergement Mutualisé"><meta property="og:description" content="Du reverse proxy pour code arbitraire sur hébergement mutualisé"><meta property="og:locale" content="fr_fr"><meta property="og:type" content="article"><meta property="article:published_time" content="2022-04-07T00:42:19+02:00"><meta property="article:modified_time" content="2023-11-04T13:52:46+01:00"><meta property="article:tag" content="Alpha"><meta property="article:tag" content="Hébergement Mutualisé"><meta property="article:tag" content="Niveau:intermédiaire"><link href=https://blog.iglou.eu/index.xml rel=alternate type=application/rss+xml title="Blog Iglou.eu"><link rel=stylesheet href=/css/style.min.04f4b7997c4f8621b627767bda0b5f35702bcb14fff156b6c784df451dba02e0.css integrity="sha256-BPS3mXxPhiG2J3Z72gtfNXAryxT/8Va2x4TfRR26AuA=" crossorigin=anonymous></head><body><div class=toggle-widget id=open-left_panel><style>#open-left_panel .toggle-close{display:none}#open-left_panel:target~.content-main .left_panel{display:block;position:fixed;top:0;left:0;right:0;bottom:0;overflow:auto;z-index:10}#open-left_panel:target .toggle-icon-line{background-color:var(--color-wtoggle-line-focus)}#open-left_panel:target .toggle-icon-line.vertical{transform:rotate(360deg)}#open-left_panel:target .toggle-icon-line.horizontal{transform:rotate(180deg)}#open-left_panel:target .toggle-close{display:initial}#open-left_panel:target .toggle-open{display:none}</style><div class=toggle-icon><span class="toggle-icon-line vertical"></span>
<span class="toggle-icon-line horizontal"></span></div><a class="toggle-open toggle-link" title="Ouvrir Left panel" href=#open-left_panel></a><a class="toggle-close toggle-link" title="Fermer Left panel" href=#close-left_panel></a></div><header class=site-header><h1>Blog Iglou.eu</h1><nav class=main-menu><ul><li><a href=/>Accueil</a></li></ul></nav></header><main class=content-main><div class=top_panel><aside class=article-info><span class=date-info>Le <time class=published datetime=2022-04-07T00:42:19+02:00>07 Apr 2022
</time>· Maj le <time class=editited datetime=2023-11-04T13:52:46+01:00>04 Nov 2023
</time></span><span class=spacer></span>
<span class=reading-time>5-8 minutes</span></aside></div><div class=left_panel><aside class=sidebar><div class=toc><h2 class=toc-title>Table des Matières</h2><nav id=TableOfContents><ul><li><a href=#reverse-proxy-dans-ton-htaccess>Reverse proxy dans ton .htaccess</a></li><li><a href=#reverse-proxy-dans-ton-php>Reverse proxy dans ton PHP</a><ul><li><a href=#avec-ton-socket-tu-munix>Avec ton Socket tu m&rsquo;Unix</a></li></ul></li><li><a href=#les-epi-de-ton-proxy>Les EPI de ton proxy</a><ul><li><a href=#le-voisin-est-un-mateur->Le voisin est un mateur 😭</a></li><li><a href=#subir-du-harcèlement->Subir du harcèlement 🦟</a></li><li><a href=#you-wa-socket->YOU wa SOCKET 🤜</a></li></ul></li><li><a href=#finissons-bons-amis->Finissons bons amis 🫂</a></li></ul></nav></div><div class=tags><h2 class=tags-title>Tags</h2><ul class=tags-list><li class=tags-item><a class=tags-link href=https://blog.iglou.eu/tags/alpha/>Alpha</a></li><li class=tags-item><a class=tags-link href=https://blog.iglou.eu/tags/h%C3%A9bergement-mutualis%C3%A9/>Hébergement Mutualisé</a></li><li class=tags-item><a class=tags-link href=https://blog.iglou.eu/tags/niveauinterm%C3%A9diaire/>Niveau:intermédiaire</a></li></ul></div></aside></div><div class=right_panel><article class="blog-article markdown"><div class="box warning monospace"><span>Cette série &ldquo;Alpha&rdquo; tourne autour du thème de l&rsquo;exécution de code
non prévu par les fournisseurs d&rsquo;hébergement mutualisé. Et ce, affin de passer
outre les limitations comme le support de langages de script ou binaires</span></div><h1 id=-viens-chez-mon-27039-jhabite-chez-443>🎤 Viens chez mon :27039, j&rsquo;habite chez :443</h1><p><em>Sur les bords au milieu, c&rsquo;est vrai qu&rsquo;je crains un peu.</em></p><p></p><figure class=article-img><a href=/images/865675824.jpg target=_blank title="Ouvrir l'image dans un onglet"><img src=/images/865675824.jpg alt="Elle mate :27039, et elle fait bien" referrerpolicy=no-referrer loading=lazy class=img-src></a><figcaption class=img-desc>Comment elle mate mon :27039 depuis son :443 😱</figcaption></figure><p></p><p>Il y a de cela fort longtemps, je me suis focalisé sur les langages de script,
et plus particulièrement PHP. Ce choix fut principalement orienté du fait que
je pensais, naïvement, qu&rsquo;elle était la seule techno permettant de profiter des
hébergements mutualisés. Mais avec l&rsquo;âge vient la sagesse, et après maintes
dépenses en serveurs dédiés pour faire tourner diverses applications. Je connais
le Kung-fu !</p><p>Il serait probablement bien plus raisonnable de commencer cette série &ldquo;Alpha&rdquo; par
l&rsquo;exécution de code ou logiciel qui ne sont pas officiellement disponibles&mldr;
Mais j&rsquo;avais la blague du matage de :27039 depuis :443 en tête, et j&rsquo;en suis
fier, même si je ne devrais pas.</p><blockquote><p>PS: <em>Attention, de l&rsquo;ironie est susceptible de s&rsquo;être glissée dans mes lignes.</em></p></blockquote><h2 id=reverse-proxy-dans-ton-htaccess>Reverse proxy dans ton .htaccess</h2><p>Je ne sais pas si vous avez déjà entendu parlé d&rsquo;un fichier du nom de
<code>.htaccess</code>. C&rsquo;est un fichier très peu utilisé, et très peu répandu sur les
hébergements mutualisés 😏 Celui-ci, quand il est supporté, permet un tas de
choses sympas vu qu&rsquo;il permet de modifier la configuration du serveur au niveau du
répertoire courant. C&rsquo;est notamment lui qui permet d&rsquo;avoir du <code>Pretty URLs</code>.</p><p>Tiens, cela tombe bien de parler des jolies URL, car pour notre reverse proxy,
nous allons utiliser le même mécanisme. Il y a donc de très grandes chances que
cette méthode fonctionne pour tous, <code>mod_rewrite</code> étant &ldquo;toujours&rdquo; disponible.</p><p>Mettons l&rsquo;hypothèse suivante, nous disposons d&rsquo;une app locale écoutant sur
<code>127.0.0.1:27039</code>, et nous désirons &ldquo;rediriger&rdquo; tout le flux arrivant vers celui-
ci. Attention, c&rsquo;est vraiment complexe, accrochez-vous bien les yeux.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>    RewriteEngine <span style=color:#66d9ef>on</span>
</span></span><span style=display:flex><span>    RewriteRule ^(.*)$ http://127.0.0.1:27039/$1 [P]
</span></span></code></pre></div><p>Restons sérieux, je vais tout de même prendre le temps de détailler.</p><ul><li><code>RewriteEngine on</code> Activation du rewrite engine&mldr;</li><li><code>RewriteRule ^(.*)$ http://127.0.0.1:27039/$1 [P]</code> THE MAGIC <del>WAND</del> LINE 🪄</li><li><code>^(.*)$</code> Attraper l&rsquo;URL de la requête initial</li><li><code>http://127.0.0.1:27039/$1</code> Redirection vers notre port local en y ajoutant
la requête initiale</li><li><code>[P]</code> La partie la plus importante, c&rsquo;est un &lsquo;rewrite flags&rsquo; qui veut dire
proxy
<a href=https://httpd.apache.org/docs/trunk/fr/rewrite/flags.html#flag_p class=external-link rel="noreferrer nofollow noopener" target=_blank>la documentation des flags</a></li></ul><p>Il me semblait qu&rsquo;il était possible, fut un temps, d&rsquo;utiliser cette même
technique pour taper directement dans un Unix Socket, via RewriteRule et une
URI type <code>unix:</code>, cela ne semble plus possible (malheureusement pour nous).
La seule solution pour exploiter un Socket avec apache serait ainsi de
passer via une instruction <code>proxypass</code>, mais celle-ci n&rsquo;est pas disponible
via .htaccess.</p><div class="box warning monospace"><span>Pour exploiter le Rewrite, le serveur doit mettre à disposition
&lsquo;mod_rewrite&rsquo;, mais aussi &lsquo;mod_proxy&rsquo; pour le flag P|proxy</span></div><h2 id=reverse-proxy-dans-ton-php>Reverse proxy dans ton PHP</h2><p>Il est ironique de passer par un langage de script pour exploiter du natif,
voire traumatisant pour certains (dont moi).</p><p>Un proxy, basiquement, a pour seule mission de transférer les informations reçues
sur un point A vers un point B. Il est possible de faire cela avec n&rsquo;importe quel
langage, et pour le coup, nous allons exploiter le support de PHP par le
serveur. N&rsquo;étant pas le seul à avoir exploré ce genre de
choses, il y a un script PHP mis à disposition par une gentille personne
<a href=https://github.com/michaelfranzl/no.php/blob/master/no.php class=external-link rel="noreferrer nofollow noopener" target=_blank>ici sur github</a>
.
Ce script utilise la lib Curl, il est envisageable de faire du plus bas niveau
avec, par exemple, l&rsquo;usage de <code>php://input</code> ainsi que <code>fsockopen</code>. Cette technique
entraîne, cependant, quelques limitations, comme les connexions persistantes…</p><p>L&rsquo;hypothèse, nous avons un domaine <code>minsc.boo</code> qui &ldquo;pointe&rdquo; vers un dossier
<code>~/minsc.boo/</code> et une application qui écoute <code>127.0.0.1:27039</code></p><ul><li>Mise en place de no.php sous <code>~/minsc.boo/index.php</code></li><li>Configuration <code>$backend_url = "http://127.0.0.1:27039"</code> et <code>$uri_rel = "index.php"</code></li></ul><p>Et… Ba voilà, c&rsquo;est tout.</p><h3 id=avec-ton-socket-tu-munix>Avec ton Socket tu m&rsquo;Unix</h3><p>Une autre approche de reverse serait d&rsquo;utiliser des Unix Socket.
Avec no.php, il faudrait effectuer des modifications, entre autres, ajouter des
directives curl comme <code>CURLOPT_UNIX_SOCKET_PATH</code>, ne pas initialiser curl avec
une URL, avoir un buffersize&mldr;</p><p>Ne comptez pas sur moi pour effectuer cette modification (quoique… une PR
ne mange pas de pain), mais certainement pas dans les mois à venir.</p><h2 id=les-epi-de-ton-proxy>Les EPI de ton proxy</h2><p><em>Équipement de Protection Individuelle</em></p><p>Sur un hébergement mutualisé, vous n&rsquo;êtes pas seul. L&rsquo;espace de travail est
est partagé avec les autres, et il est possible que votre voisinage soit malveillant.
Tout repose sur la politique de sécurité de votre hébergeur et la qualité de
son isolation des environnements utilisateurs.</p><p>De plus <code>THERE IS NO CLOUD. It’s just someone else’s computer</code>, et qui vous dit que
<code>someone else</code>, n&rsquo;est pas un peu trop curieux ?!</p><p>Mettez vos EPI, c&rsquo;est parti pour un petit tour de piste des problématiques possibles
dans un environnement mutualisé ayant des problèmes de sécurité.</p><h3 id=le-voisin-est-un-mateur->Le voisin est un mateur 😭</h3><p>Comme vous avez pu le constater, tout le trafic de notre reverse proxy passe
localement via le protocole <code>http</code>. Il n&rsquo;est effectivement pas possible de
passer des instructions comme <code>SSLProxyCACertificateFile</code> via le
fichier .htaccess. La confidentialité tout comme l&rsquo;intégrité des données ne
peuvent donc pas être assurées localement.</p><p>Il y a quelques solutions possibles et passionnantes à mettre en place, comme :</p><ul><li>Le chiffrement de bout en bout, cela fera les pieds au mec du milieu</li><li>Transmissions des informations de connexions via des hash uniquement</li><li>Implémenter un système comparable à <code>Auth Digest</code> avec <code>qop=auth-int</code> en
bidirectionnel</li><li>Instaurer un contrat de confiance SSL avec la solution en PHP</li></ul><h3 id=subir-du-harcèlement->Subir du harcèlement 🦟</h3><p>Dans le cas d&rsquo;un harceleur, celui-ci pourrait venir frapper à votre :27039
plusieurs fois par seconde, que ce soit pour voir qui répond, ce qu&rsquo;il en ressort,
voler des mots de passe&mldr; Un véritable cauchemar de DoS et brute-force local.</p><p>Impossible de se protéger, Car toutes les requêtes seront émises localement
et toutes auront la même origine locale 🤷. Il est même possible à notre
voisin de mentir sur son header pour faire porter le chapeau à un pauvre
innocent !</p><h3 id=you-wa-socket->YOU wa SOCKET 🤜</h3><p><em>Ai de sora ga ochite kuru</em></p><p>La méthode la plus élégante est de passer par un Unix Socket 😍</p><p>En plus d&rsquo;avoir une exposition relativement limitée, elle est aussi très
discrète, vu qu&rsquo;elle n&rsquo;ouvre pas de port, mais un socket Unix. Ce qui pour un
administrateur est tout de même moins voyant qu&rsquo;un nouveau port qui pop&mldr;</p><p>Malheureusement, même si c&rsquo;est la méthode la plus élégante, elle n&rsquo;est pas
beaucoup plus efficace contre les voyeurs et harceleurs. Des outils comme
<code>strace</code>, permettent à un utilisateur avec suffisamment de privilèges de voir,
entre autres, ce qui se passe sur un socket Unix.</p><h2 id=finissons-bons-amis->Finissons bons amis 🫂</h2><p>Sur le test de 6 hébergements mutualisés, tous avaient</p><ul><li>Une isolation de mon environnement d&rsquo;exécution</li><li>Une isolation de l&rsquo;espace de travail</li><li>Une isolation du réseau (type sandbox)</li></ul><p>C&rsquo;est une pratique qui me fut utile et j&rsquo;aime faire joujou avec les possibilités.
Dans la 3ᵉ partie de cette série, nous aborderons une alternative bien connue
et pourtant oublié, voir méprisée.</p><div class="box warning monospace"><span>Les hébergements mutualisés ne sont pas toujours très transparents
sur ce qu&rsquo;ils acceptent ou pas. Il est donc nécessaire d&rsquo;être prudent sur les
déploiements que vous entreprendrez</span></div><p>Ce fut un plaisir de vous partager ce maigre savoir, que j&rsquo;ai acquis à la force
mes aventures numériques.</p><p><strong>À plus dans l&rsquo;bus</strong></p></article></div></main><footer class=site-footer><p>Copyright 2024 CC0 - Sans Cookies ni tracking</p></footer></body></html>