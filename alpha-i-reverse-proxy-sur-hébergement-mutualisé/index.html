<!doctype html><html lang=fr><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,user-scalable=yes,viewport-fit=cover"><title>[Alpha I] Reverse Proxy Sur H√©bergement Mutualis√© | Blog Iglou.eu</title><meta property="og:title" content="[Alpha I] Reverse Proxy Sur H√©bergement Mutualis√© | Blog Iglou.eu"><meta property="og:locale" content="fr_fr"><meta name=theme-color content="#dbf3f4"><meta name=author content="Adrien K"><meta name=description content="Cette s√©rie &#34;Alpha&#34;, tourne autour du th√®me de l'ex√©cution de code non pr√©vus par les fournisseurs d'h√©bergement mutualis√©. Et ce, affin de passer outre des limitations comme le support de langages de script ou binaires üé§ Viens chez mon :27039, j&amp;rsquo;habite chez :443 Sur les bords au milieu c&amp;rsquo;est vrai qu&amp;rsquo;je crains un peu.

Comment elle mate mon :27039 depuis son :443 üò±   
Il y a de cela fort longtemps, je me suis focalis√© sur les langages de script, et plus particuli√®rement PHP."><meta property="og:type" content="article"><meta property="og:description" content="Cette s√©rie &#34;Alpha&#34;, tourne autour du th√®me de l'ex√©cution de code non pr√©vus par les fournisseurs d'h√©bergement mutualis√©. Et ce, affin de passer outre des limitations comme le support de langages de script ou binaires üé§ Viens chez mon :27039, j&amp;rsquo;habite chez :443 Sur les bords au milieu c&amp;rsquo;est vrai qu&amp;rsquo;je crains un peu.

Comment elle mate mon :27039 depuis son :443 üò±   
Il y a de cela fort longtemps, je me suis focalis√© sur les langages de script, et plus particuli√®rement PHP."><meta property="og:publish_date" name=publish_date content="2022-04-07T00:42:19+02:00"><meta property="article:published_time" content="2022-04-07T00:42:19+02:00"><meta property="article:modified_time" content="2022-04-07T00:42:19+02:00"><meta property="article:author" content="Adrien K"><meta property="article:tag" content="alpha Serveur"><meta property="og:site_name" content="Blog Iglou.eu"><meta property="og:type" content="blog"><link rel=icon href="data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Ctext y=%22.9em%22 font-size=%2290%22%3E%F0%9F%92%BE%3C/text%3E%3C/svg%3E"><link rel=canonical href=https://blog.iglou.eu/alpha-i-reverse-proxy-sur-h%C3%A9bergement-mutualis%C3%A9/><meta property="og:url" content="https://blog.iglou.eu/alpha-i-reverse-proxy-sur-h%C3%A9bergement-mutualis%C3%A9/"><style>:root{--c-dark:#33331a;--c-light:#dbf3f4;--c-primary:var(--c-light);--c-secondary:var(--c-dark);--ff-monospace:'Roboto Mono', SFMono-Regular, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;--ff-sans-serif:'Roboto', "Segoe UI", "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif}pre,code{--c-secondary:var(--c-light);--c-primary:var(--c-dark)}.btn:hover,.btn:focus{--c-primary:var(--c-dark);--c-secondary:var(--c-light)}*,::after,::before{box-sizing:border-box}.link.inherit{color:inherit}.link.important{color:var(--c-primary);border:.1em dotted transparent;padding:.25em .5em;text-decoration:underline double .05em}.link.important:hover,.link.important:focus{border-color:var(--c-primary);text-decoration:underline .1em}.link.svg{line-height:0;text-decoration:none}.link.svg>svg{fill:var(--c-primary);height:2em}.btn{color:var(--c-primary);border:.1em solid;padding:.25em .5em;display:inline-block;text-decoration:none;background-color:var(--c-secondary)}.box{gap:1em;border:.1em solid;padding:.5em 1em;display:grid;grid-template-columns:auto 1fr}.box::before{content:"";font-size:2em;line-height:.3em}.box.warning::before{content:"‚ö†"}.intext{font-size:inherit;display:inline}.monospace{font-family:var(--ff-monospace)}.capitalize{text-transform:capitalize}.right{text-align:right}.center{text-align:center}.m0{margin:0}.emoji{color:transparent;text-shadow:0 0 0 var(--c-primary)}.hr{margin:1em 0;border:none;border-bottom:.1em solid var(--c-primary)}.infos,.ariane{padding:.25em .5em;font-weight:700}.infos{gap:.5em;display:grid;margin-top:.5em;margin-bottom:.5em;grid-template-columns:1fr auto}.ariane{border:.1em solid var(--c-primary);border-left:none;border-right:none}body{color:var(--c-primary);font-size:1.2rem;line-height:1.4rem;font-family:var(--ff-sans-serif);background-color:var(--c-secondary);max-width:70em;margin:auto}.article h2::after{content:"";display:block;width:60%;height:1px;background-color:var(--c-primary);margin-top:.15em}pre{color:var(--c-primary);padding:1em;overflow:auto;max-height:100vh;background:var(--c-secondary)}code:not([data-lang]){color:var(--c-primary);background:var(--c-secondary);font-family:var(--ff-monospace);border-radius:3px}.site_title{font-size:3em;text-align:center;line-height:initial;text-shadow:0 0 1px var(--c-primary),0 0 1px var(--c-primary)}.article{margin:1em auto;max-width:80rem}.article_content__img{width:30em;color:var(--c-secondary);cursor:pointer;padding:1em;max-width:100%;text-align:center;font-style:italic;font-weight:700;background-color:var(--c-primary)}.article_content__img_src,.article_content__img:focus{width:100%}.article_content__img_src{max-height:50vh;object-fit:contain}.article_content__img:focus .article_content__img_src{max-height:100vh}.article_comm{margin-top:2em}.main.branch{display:grid;line-height:1.5em;grid-template-columns:minmax(25em,2fr)minmax(10em,1fr)}.articles{width:fit-content;margin:auto}.article_link{border:.1em solid var(--c-primary);margin:1em 0;padding:1.5em;max-width:50em;font-weight:700}.article_link__header,.article_link__footer{gap:1em;display:grid}.article_link__header{margin-bottom:1.5em;grid-template-columns:minmax(15rem,1fr)1fr}.article_link__footer{margin-top:2em;grid-template-columns:1fr auto}.article_link__title>.link{line-height:1.25em;text-decoration:underline .1em transparent}.article_link__title>.link:hover,.article_link__title>.link:focus{text-decoration-color:var(--c-primary)}.paginator{font-size:1.25em;text-align:center}.author{color:var(--c-primary);width:fit-content;margin:1em auto;height:fit-content;padding:0 1em 1em;max-width:20em;background-color:var(--c-secondary)}.author_view{border-radius:1em;width:100%}.author_desc__name{margin-bottom:.25em}.author_social{display:flex;justify-content:space-between}@media(max-width:768px){body{font-size:1rem}.site_title{font-size:1.8em}.main.branch{display:block}.author{max-width:initial}.author_view{max-width:20em}.infos{display:block}.infos>span{padding:0 .15em;border-style:solid;border-width:0 0 0 1px}.article_content__img{margin:auto}.article{margin:1em .15em}.article_comm .btn{margin:.25em}}</style></head><body><header><h1 class="site_title monospace"><a href=/ class="link inherit">Blog.Iglou.eu</a></h1><div class="ariane monospace">/&#8239;<a href=/ class="link inherit">Home</a>&#8239;/&#8239;<h2 class="intext capitalize">[Alpha I] Reverse Proxy Sur H√©bergement Mutualis√©</h2></div><aside class="infos monospace"><span class=infos_by>Par Adrien K</span>
<span class="infos_date right">Le <time class="article_link__date_format text_neon blue" datetime=2022-04-07T00:42:19+02:00>07 Apr 2022</time></span>
<span class=infos_time>Lecture 8 minutes</span>
<span class="infos_tags capitalize right"><a class="article_link__tag link important alpha" href=/tags/alpha/>alpha</a>
<a class="article_link__tag link important Serveur" href=/tags/Serveur/>Serveur</a></span></aside></header><main class=main><article class=article><div class="box warning monospace"><span>Cette s√©rie "Alpha", tourne autour du th√®me de l'ex√©cution de code
non pr√©vus par les fournisseurs d'h√©bergement mutualis√©. Et ce, affin de passer
outre des limitations comme le support de langages de script ou binaires</span></div><h1 id=-viens-chez-mon-27039-jhabite-chez-443>üé§ Viens chez mon :27039, j&rsquo;habite chez :443</h1><p><em>Sur les bords au milieu c&rsquo;est vrai qu&rsquo;je crains un peu.</em></p><p></p><figure class=article_content__img tabindex=0><img src=/images/865675824.jpg alt="Elle mate :27039, et elle fait bien" referrerpolicy=no-referrer loading=lazy class=article_content__img_src><figcaption class=article_content__img_desc>Comment elle mate mon :27039 depuis son :443 üò±</figcaption></figure><p></p><p>Il y a de cela fort longtemps, je me suis focalis√© sur les langages de script,
et plus particuli√®rement PHP. Ce choix fut principalement orient√©, du fait que
je pensais na√Øvement, qu&rsquo;elle √©tait la seule techno permettant de profiter des
h√©bergements mutualis√©s. Mais avec l&rsquo;age vient la sagesse, et apr√®s maintes
d√©penses en serveur d√©di√© pour faire tourner diverses applications. Je connais
le Kung-fu !</p><p>Il serait probablement bien plus raisonnable de commencer cette s√©rie &ldquo;Alpha&rdquo;, par
l&rsquo;ex√©cution de code ou logiciel qui ne sont pas officiellement disponibles&mldr;
Mais j&rsquo;avais la blague du matage de :27039 depuis :443 en t√™te, et j&rsquo;en suis
fi√®re, m√™me si je ne devrais pas.</p><h2 id=reverse-proxy-dans-ton-htaccess>Reverse proxy dans ton .htaccess</h2><p>Je ne sais pas si vous avez d√©j√† entendu parl√© d&rsquo;un fichier du nom de
<code>.htaccess</code>. C&rsquo;est un fichier tr√®s peu utilise, et tr√®s peu rependu sur les
h√©bergements mutualis√©s üòè Celui-ci, quand il est support√©, permet un tas de
choses sympa vu qu&rsquo;il permet modifier la configuration du serveur au niveau du
r√©pertoire courant. C&rsquo;est notamment lui qui permet d&rsquo;avoir du <code>Pretty URLs</code>.</p><p>Tien, cela tombe bien de parler des jolies URL, car pour notre reverse proxy,
nous allons utiliser le m√™me m√©canisme. Il y a donc de tr√®s grandes chances que
cette m√©thode fonctionne pour tous, <code>mod_rewrite</code> √©tant &ldquo;toujours&rdquo; disponible.</p><p>Mettons l&rsquo;hypoth√®se suivante, nous disposons d&rsquo;une app local √©coutant sur
<code>127.0.0.1:27039</code>, et nous d√©sirons &ldquo;rediriger&rdquo; tout le flux arrivant vers celui
ci. Attention, c&rsquo;est vraiment complexe, accrochez-vous bien les yeux.</p><pre tabindex=0><code class=language-dracula data-lang=dracula>    RewriteEngine on
    RewriteRule ^(.*)$ http://127.0.0.1:27039/$1 [P]
</code></pre><p>Restons s√©rieux, je vais tout de m√™me prendre le temps de d√©tailler.</p><ul><li><code>RewriteEngine on</code> Activation du rewrite engine&mldr;</li><li><code>RewriteRule ^(.*)$ http://127.0.0.1:27039/$1 [P]</code> THE MAGIC <del>WAND</del> LINE ü™Ñ</li><li><code>^(.*)$</code> Attraper l&rsquo;URL de la requ√™te initial</li><li><code>http://127.0.0.1:27039/$1</code> Redirection vers notre port local en y ajoutant
la requ√™te initiale</li><li><code>[P]</code> La partie la plus importante, c&rsquo;est un &lsquo;rewrite flags&rsquo; qui veut dire
proxy <a href=https://httpd.apache.org/docs/trunk/fr/rewrite/flags.html#flag_p class="article_content__link link inherit" rel="noreferrer nofollow noopener">la documentation des flags</a></li></ul><p>Il me semblait qu&rsquo;il √©tait possible, fut un temps, d&rsquo;utiliser cette m√™me
technique pour taper directement dans un Unix Socket, via RewriteRule et une
URI type <code>unix:</code>, cela ne semble plus possible (malheureusement pour nous).
La seule solution pour exploiter un Socket avec apache serait de ce fait de
passer par une instruction <code>proxypass</code>, mais celle-ci n&rsquo;est pas disponible
via un .htaccess.</p><div class="box warning monospace"><span>Pour exploiter cette solution, le serveur doit mettre √† disposition
'mod_rewrite', mais aussi 'mod_proxy' pour le flag P|proxy</span></div><h2 id=reverse-proxy-dans-ton-php>Reverse proxy dans ton PHP</h2><p>Il est ironique de passer par un langage de script pour exploiter du natif,
voire traumatisant pour certains (dons moi).</p><p>Un proxy, basiquement, a pour seule mission de transf√©rer les informations re√ßu
sur un point A vers un point B. Il est possible de faire cela avec n&rsquo;importe quel
langages, et pour le coup nous allons exploiter le support de PHP par le
serveur. Comme je ne suis bien s√ªr pas le seul √† avoir exploit√© ce genre de
choses, il y a un script PHP mis √† disposition par une gentille personne
<a href=https://github.com/michaelfranzl/no.php/blob/master/no.php class="article_content__link link inherit" rel="noreferrer nofollow noopener">ici sur github</a>.
Ce script utilise la lib Curl, il est envisageable de faire du plus bas niveau
avec par exemple l&rsquo;usage de <code>php://input</code> ainsi que <code>fsockopen</code>. Cette technique
entraine, cependant, quelques limitations, comme les connexions persistantes‚Ä¶</p><p>L&rsquo;hypoth√®se, nous avons un domaine <code>minsc.boo</code> qui &ldquo;pointe&rdquo; vers un dossier
<code>~/minsc.boo/</code> et une application qui √©coute <code>127.0.0.1:27039</code></p><ul><li>Mise en place de no.php sous <code>~/minsc.boo/index.php</code></li><li>Configuration <code>$backend_url = "http://127.0.0.1:27039"</code> et <code>$uri_rel = "index.php"</code></li></ul><p>Et‚Ä¶ Ba voil√†, c&rsquo;est tout.</p><h3 id=avec-ton-socket-tu-munix>Avec ton Socket tu m&rsquo;Unix</h3><p>Avec cette autre approche de reverse via PHP, il est aussi envisageable d&rsquo;utiliser
des Unix Socket. En modifiant no.php il faudrait, entre autre, ajouter des
directives curl comme <code>CURLOPT_UNIX_SOCKET_PATH</code>, ne pas initialiser curl avec
une url, avoir un buffersize&mldr;</p><h2 id=les-epi-de-ton-proxy>Les EPI de ton proxy</h2><p><em>√âquipement de Protection Individuelle</em></p><h3 id=le-voisin-est-un-mateur->Le voisin est un mateur üò≠</h3><p>Comme vous avez pu le constater, tout le trafique de notre reverse proxy passant
par un port, ce fait sur le protocole <code>http</code>. Il n&rsquo;est effectivement pas
possible de passer des instructions comme <code>SSLProxyCACertificateFile</code> via le
fichier .htaccess. La confidentialit√© tout comme l&rsquo;int√©grit√© des donn√©es ne
peuvent donc pas √™tre assur√©e .</p><p>Il y a cependant quelques solutions viables et passionnantes √† mettre en place,
comme :</p><ul><li>Le chiffrement de bout en bout, cela fera les pieds au mec du milieu</li><li>Transmissions des informations de connexions via des hash uniquement</li><li>Impl√©menter un syst√®me comparable a <code>Auth Digest</code> avec <code>qop=auth-int</code> mais
bidirectionnel</li><li>Instaurer un contrat de confiance SSL avec la solution en PHP</li></ul><h3 id=subir-du-harc√®lement->Subir du harc√®lement ü¶ü</h3><p>Suivant la s√©curit√© mise en place par votre h√©bergeur, il est probable que
vous n&rsquo;ayez aucunes protection sur l&rsquo;exploitation d&rsquo;un port local. Il
est possible que votre voisin frappe √† votre :27039 plusieurs fois par
jours, que ce soit pour voir qui r√©pond, ce qu&rsquo;il en ressort, voler des mots de
passe&mldr; Avec une sensibilit√© accrue aux brute-force</p><p>Dans le cas pr√©sent, impossible de se prot√©ger efficacement √† notre niveau.
Tout repose uniquement de la politique de s√©curit√© de l&rsquo;h√©bergeur. Si votre
application cette limite bien a l&rsquo;adresse locale, c&rsquo;est d√©j√† √ßa, toutes les
requ√™tes seront √©mises localement, mais toutes auront la m√™me origine ü§∑</p><h3 id=you-wa-socket->YOU wa SOCKET ü§ú</h3><p><em>Ai de sora ga ochite kuru</em></p><p>La m√©thode la plus s√©curis√©e √©tant de passer par un Unix Socket. Bien que vous
devriez √™tre chroot et que cette mesure peut √™tre inutile, limiter son acc√®s
exclusivement √† votre utilisateur.</p><p>En plus d&rsquo;avoir une exposition relativement limit√©e, elle est aussi tr√®s
discr√®te, vu qu&rsquo;elle n&rsquo;ouvre pas de port. Ce qui pour un administrateur syst√®me
est tout de m√™me moins voyant qu&rsquo;un nouveau port qui pop&mldr;</p><p>Cela me donne tr√®s envie de faire un proxy PHP pour les Unix Socket, mais vu le
nombre de projets d√©j√† en cours‚Ä¶</p><h2 id=finissons-bons-amis->Finissons bons amis ü´Ç</h2><p>Sur le test de 6 h√©bergements mutualis√©, tous avaient</p><ul><li>Une isolation de mon environnement d&rsquo;ex√©cution</li><li>Une isolation de mon espace de travail <code>cat /proc/&lt;ENV>/mountinfo</code> contient une ligne <code>/&lt;ID> /home/&lt;ID></code></li><li>Pas d&rsquo;offuscation ou isolation des ports</li></ul><p>C&rsquo;est une pratique qui me fut utile et j&rsquo;aime partager un savoir, que j&rsquo;ai acquis
avec le temps. Celui-ci n&rsquo;est malheureusement pas tr√®s utile ou recommand√© :)</p><p>Je ne saurais que trop vous conseiller d&rsquo;apprendre √† faire du d√©ploiement
ServeurLess, m√™me si d√©tourner ces h√©bergements est intrigant et pratique.</p><div class="box warning monospace"><span>Les h√©bergements mutualise ne sont pas toujours tr√®s transparents
sur ce qu'ils acceptent ou pas. Il est donc n√©cessaire d'√™tre prudent sur les
d√©ploiement que vous entreprendrez</span></div><p>Comme dit l&rsquo;adage</p><blockquote><p>THERE IS NO CLOUD. It‚Äôs just someone else‚Äôs computer</p></blockquote><p><strong>√Ä plus dans l&rsquo;bus</strong></p><aside class="article_comm right"><a class="article_comm__email btn inherit right monospace" href="mailto:adrien@iglou.eu?subject=%5BCommentaire%5D+%5bAlpha%20I%5d%20Reverse%20Proxy%20Sur%20H%c3%a9bergement%20Mutualis%c3%a9&body=Bonjour%20Adrien%2C%0D%0A">M'envoyer un commentaire</a>
¬∑
<a class="article_comm__issue btn inherit right monospace" href="https://github.com/IGLOU-EU/blog.iglou.eu/issues/new?title=Erreur:+%5bAlpha%20I%5d%20Reverse%20Proxy%20Sur%20H%c3%a9bergement%20Mutualis%c3%a9&body=Lien:+https%3a%2f%2fblog.iglou.eu%2falpha-i-reverse-proxy-sur-h%25C3%25A9bergement-mutualis%25C3%25A9%2f%0A%0AMince+quel+est+mon+erreur+?%0A">Reporter une erreur</a></aside></article></main><footer><hr class=hr><p class="footer monospace center">Site et contenue sous CC0 - Iconographie par Font Awesome - Sans Cookies ni tracking</p></footer></body></html>